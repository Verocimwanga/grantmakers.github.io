db.getCollection('990_normalized').aggregate(
  [
    { '$sort': { 'normalized.ein': 1, 'normalized.tax_period': -1, 'normalized.last_updated_irs': -1 } },
    { '$group': {
      '_id': '$normalized.ein',
      'last_updated_grantmakers': { '$first': '$normalized.last_updated_grantmakers'},
      'last_updated_irs': { '$first': '$normalized.last_updated_irs'},
      'ein': { '$first': '$normalized.ein' },
      'organization_name': { '$first': '$normalized.organization_name' },
      'names': { '$push': {'organization_name': '$normalized.organization_name' }},
      // 'assets': { '$first': '$normalized.assets' },
      'website': { '$first': '$normalized.website' },
      'city': { '$first': '$normalized.city' },
      'state': { '$first': '$normalized.state'},
      'country': {'$first': '$normalized.country'},
      'is_foreign': {'$first': '$normalized.is_foreign'},
      // 'is_likely_staffed': { '$first': '$normalized.is_likely_staffed' },
      'has_website': { '$first': '$normalized.has_website' },
      'mission': { '$first': '$normalized.mission' },
      'mission_alt': { '$first': '$normalized.mission' },
      'filings': {
        '$push': {
          'object_id_irs': '$normalized.object_id_irs',
          'tax_period': '$normalized.tax_period',
          'tax_year': '$normalized.tax_year',
          'url': '$normalized.url',
        },
      },
      // 'people': { '$first': '$normalized.people'},
    }},
    { '$project': {
      '_id': 1,
      'last_updated_grantmakers': 1,
      'last_updated_irs': 1,
      'ein': 1,
      'organization_name': 1,
      'organization_name_prior_year': { '$arrayElemAt': ['$names.organization_name', 1]},
      'organization_name_second_prior_year': { '$arrayElemAt': ['$names.organization_name', 2]},
      // 'assets': 1,
      'website': 1,
      'city': 1,
      'state': 1,
      'country': 1,
      'is_foreign': 1,
      // 'is_likely_staffed': 1,
      'has_website': 1,
      'mission': 1,
      'mission_alt': 1,
      'filings': 1,
      // 'people': 1,
    }},
    { '$out': '990_aggregated' },
  ],
  { 'allowDiskUse': true }
);
